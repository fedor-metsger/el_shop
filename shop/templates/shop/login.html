{% extends "shop/base.html" %}

{% load static %}

{% block title %}Вход{% endblock %}

{% block content %}
    <div class="card-header">
        <h3>Вход</h3>
    </div>

    <div class="album py-3 bg-light">
        <div class="container">
            <div class="card mb-4 box-shadow">
                <div class="card-body">
                    <form method="post" id="loginForm">
                        {% csrf_token %}
                        {{ form.as_p }}
                        <button class="btn btn-primary" type="submit">Войти</button>
                        <button type="button" class="btn btn-success" onclick="clickGetToken()">Получить токен</button>
                        <input name="next" type="hidden" value="{% url 'backend:product-list' %}">
                        <div class="mb-3">
                            <label for="tokenPost">Токен:</label>
                            <textarea class="form-control" id="tokenPost"
                                      style="font-family:Monospace;"
                                      placeholder="Token" readonly>
                            </textarea>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block javascript %}
    <script>
        const inputToken = document.getElementById("token");

        function getToken(url, data, element) {
            $.ajax({
                url: url,
                method: "POST",
                data: data,
                dataType: "json",
                success: (data) => {
                    {#console.log(data["access"]);#}
                    window.localStorage.setItem("token", data["access"]);
                    inputToken.value = window.localStorage.getItem("token");
                    console.log(window.localStorage.getItem("token"));
                    element.value = JSON.stringify(data, null, 4);
                    element.style.height = (element.scrollHeight) + "px"
                },
                error: (jqXHR, e) => {
                    console.log("status: " + jqXHR.status + " (" + jqXHR.statusText + ")");
                    element.value = "status: " + jqXHR.status + " (" + jqXHR.statusText + ")";
                    element.style.height = (element.scrollHeight) + "px"
                }
            });
        }

        function clickGetToken() {
            var data = {
                email: loginForm.elements["emailPost"].value,
                password: loginForm.elements["passwordPost"].value,
            }
            getToken("{% url 'shop:token-obtain' %}", data, loginForm.elements["tokenPost"]);
        }
    </script>
{% endblock %}
